<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>index.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
  <style type="text/css">
    .octowrap { display: none; }
    td.docs, td.code { border-top: solid 1px #eee; }
    td.docs { text-align: right; }
  </style>
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>index.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-1">#</a>
        </div>
        <h1>Ion</h1>

<p> <strong>A search engine written in Ruby and uses Redis.</strong></p>

<p> Github: <a href="http://github.com/rstacruz/ion">http://github.com/rstacruz/ion</a></p>

<p> Ion is under a state merciless refactoring until it reaches a
 useable feature set&mdash;use at your own risk :)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-2">#</a>
        </div>
        <h2>Why use it?</h2>

<ul>
<li><p>You need searching for your app, but the overhead of Solr
is too much for you.</p></li>
<li><p>When simple full text searches of your DB isn&rsquo;t enough, and
you need complex criteria in your searches.</p></li>
</ul>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-3">#</a>
        </div>
        <h2>Setup</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-4">#</a>
        </div>
        <p> Do the <code>gem install ion</code> dance, Oh, and Ion needs Redis.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;ion&#39;</span>
<span class="no">Ion</span><span class="o">.</span><span class="n">connect</span> <span class="n">url</span><span class="p">:</span> <span class="s1">&#39;redis://127.0.0.1:6379/0&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-5">#</a>
        </div>
        <h2>Setting up your model</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-6">#</a>
        </div>
        <p> Any ORM will do. As long as you can hook it to update Ion&rsquo;s indices, you&rsquo;ll be fine.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nc">Album</span> <span class="o">&lt;</span> <span class="no">Ohm</span><span class="o">::</span><span class="no">Model</span>
  <span class="kp">include</span> <span class="no">Ion</span><span class="o">::</span><span class="no">Entity</span>
  <span class="kp">include</span> <span class="no">Ohm</span><span class="o">::</span><span class="no">Callbacks</span>  <span class="c1"># for `after` and `before`</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-7">#</a>
        </div>
        <p> So, say you have these fields.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">attribute</span> <span class="ss">:name</span>
  <span class="n">attribute</span> <span class="ss">:artist</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-8">#</a>
        </div>
        <p> You can set them up to be indexed like so:</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">ion</span> <span class="p">{</span>
    <span class="n">text</span> <span class="ss">:name</span>
    <span class="n">metaphone</span> <span class="ss">:artist</span>
  <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-9">#</a>
        </div>
        <p> Just call these funcions on save and delete.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">after</span>  <span class="ss">:save</span><span class="p">,</span>   <span class="ss">:update_ion_indices</span>
  <span class="n">before</span> <span class="ss">:delete</span><span class="p">,</span> <span class="ss">:delete_ion_indices</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-10">#</a>
        </div>
        <h2>Searching</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-11">#</a>
        </div>
        <p> Searching is easy.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">results</span> <span class="o">=</span> <span class="no">Album</span><span class="o">.</span><span class="n">ion</span><span class="o">.</span><span class="n">search</span> <span class="p">{</span>
  <span class="n">text</span> <span class="ss">:name</span><span class="p">,</span> <span class="s2">&quot;Dancing Galaxy&quot;</span>
<span class="p">}</span>

<span class="n">results</span> <span class="o">=</span> <span class="no">Album</span><span class="o">.</span><span class="n">ion</span><span class="o">.</span><span class="n">search</span> <span class="p">{</span>
  <span class="n">metaphone</span> <span class="ss">:artist</span><span class="p">,</span> <span class="s2">&quot;Astral Projection&quot;</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-12">#</a>
        </div>
        <p> The results will be an <code>Enumerable</code> object. Go ahead and iterate as you normally would.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">results</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">album</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;Album &#39;</span><span class="si">#{</span><span class="n">album</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; (by </span><span class="si">#{</span><span class="n">album</span><span class="o">.</span><span class="n">artist</span><span class="si">}</span><span class="s2">)&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-13">#</a>
        </div>
        <p> You can also get the raw results easily.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">results</span><span class="o">.</span><span class="n">to_a</span>  <span class="c1">#=&gt; [&lt;#Album&gt;, &lt;#Album&gt;, ... ]</span>
<span class="n">results</span><span class="o">.</span><span class="n">ids</span>   <span class="c1">#=&gt; [&quot;1&quot;, &quot;2&quot;, &quot;10&quot;, ... ]</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-14">#</a>
        </div>
        <h1>Features</h1>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-15">#</a>
        </div>
        <h2>Custom indexing functions</h2>

<p> By default, doing <code>text :name</code> will query your record&rsquo;s <code>name</code> attribute.
 This can be easily changed by supplying a block.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">Ohm</span><span class="o">::</span><span class="no">Model</span>
  <span class="n">attribute</span> <span class="ss">:name</span>
  <span class="n">attribute</span> <span class="ss">:synopsis</span>
  <span class="n">reference</span> <span class="ss">:author</span><span class="p">,</span> <span class="no">Person</span>

  <span class="n">ion</span> <span class="p">{</span>
    <span class="n">text</span><span class="p">(</span><span class="ss">:author</span><span class="p">)</span> <span class="p">{</span> <span class="n">author</span><span class="o">.</span><span class="n">name</span> <span class="p">}</span>  <span class="c1"># Supply your own indexing function</span>
  <span class="p">}</span>
<span class="k">end</span>

<span class="no">Book</span><span class="o">.</span><span class="n">ion</span><span class="o">.</span><span class="n">search</span> <span class="p">{</span> <span class="n">text</span> <span class="ss">:author</span><span class="p">,</span> <span class="s2">&quot;Patrick Suskind&quot;</span> <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-16">#</a>
        </div>
        <h2>Nested conditions</h2>

<p> By default, doing a <code>.search { ... }</code> does an <code>all_of</code> search (that is,
 it must match all the given rules). You can use <code>any_of</code> and <code>all_of</code>, and
 you may even nest them.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="no">Book</span><span class="o">.</span><span class="n">ion</span><span class="o">.</span><span class="n">search</span> <span class="p">{</span>
  <span class="n">all_of</span> <span class="p">{</span>
    <span class="n">text</span> <span class="ss">:name</span><span class="p">,</span>     <span class="s2">&quot;perfume the story of a murderer&quot;</span>
    <span class="n">text</span> <span class="ss">:synopsis</span><span class="p">,</span> <span class="s2">&quot;base note&quot;</span>
    <span class="n">any_of</span> <span class="p">{</span>
      <span class="n">text</span> <span class="ss">:tags</span><span class="p">,</span> <span class="s2">&quot;fiction&quot;</span>
      <span class="n">text</span> <span class="ss">:tags</span><span class="p">,</span> <span class="s2">&quot;thriller&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-17">#</a>
        </div>
        <h2>Important rules</h2>

<p> You can make certain rules score higher than the rest. In this example,
 if the search string is found in the name, it&rsquo;ll rank higher than if it
 was found in the synopsis.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="no">Book</span><span class="o">.</span><span class="n">ion</span><span class="o">.</span><span class="n">search</span> <span class="p">{</span>
  <span class="n">any_of</span> <span class="p">{</span>
    <span class="n">score</span><span class="p">(</span><span class="mi">5</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="n">text</span> <span class="ss">:name</span><span class="p">,</span> <span class="s2">&quot;Darkly Dreaming Dexter&quot;</span> <span class="p">}</span>
    <span class="n">score</span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="n">text</span> <span class="ss">:synopsis</span><span class="p">,</span> <span class="s2">&quot;Darkly Dreaming Dexter&quot;</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-18">#</a>
        </div>
        <h2>Boosting</h2>

<p> You can define rules on what will rank higher.</p>

<p> This is different from <code>score</code> (above) in such that it only boosts current
 results, and doesn&rsquo;t add any. For instance, below, it will not show all
 &ldquo;sale&rdquo; items, but will make any sale items in the current result set
 rank higher.</p>

<p> This example will boost the score of sale items by x2.0.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="no">Book</span><span class="o">.</span><span class="n">ion</span><span class="o">.</span><span class="n">search</span> <span class="p">{</span>
  <span class="n">text</span> <span class="ss">:name</span><span class="p">,</span> <span class="s2">&quot;The Taking of Sleeping Beauty&quot;</span>
  <span class="n">boost</span><span class="p">(</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="n">text</span> <span class="ss">:tags</span><span class="p">,</span> <span class="s2">&quot;sale&quot;</span> <span class="p">}</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-19">#</a>
        </div>
        <h2>Metaphones</h2>

<p> Indexing via metaphones allows you to search by how something sounds like,
 rather than with exact spellings.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">Ohm</span><span class="o">::</span><span class="no">Model</span>
  <span class="n">attribute</span> <span class="ss">:name</span>

  <span class="n">ion</span> <span class="p">{</span>
    <span class="n">metaphone</span> <span class="ss">:name</span>
  <span class="p">}</span>
<span class="k">end</span>

<span class="no">Person</span><span class="o">.</span><span class="n">create</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Stephane Michael Cook&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-20">#</a>
        </div>
        <p> Any of these will work.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="no">Person</span><span class="o">.</span><span class="n">ion</span><span class="o">.</span><span class="n">search</span> <span class="p">{</span> <span class="n">metaphone</span> <span class="ss">:name</span><span class="p">,</span> <span class="s1">&#39;stiefen michel cooke&#39;</span> <span class="p">}</span>
<span class="no">Person</span><span class="o">.</span><span class="n">ion</span><span class="o">.</span><span class="n">search</span> <span class="p">{</span> <span class="n">metaphone</span> <span class="ss">:name</span><span class="p">,</span> <span class="s1">&#39;steven quoc&#39;</span> <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-21">#</a>
        </div>
        <h2>Ranges</h2>

<p> You may limit your results set like so.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">results</span> <span class="o">=</span> <span class="no">Book</span><span class="o">.</span><span class="n">ion</span><span class="o">.</span><span class="n">search</span> <span class="p">{</span>
  <span class="n">text</span> <span class="ss">:author</span><span class="p">,</span> <span class="s2">&quot;Anne Rice&quot;</span>
<span class="p">}</span>

<span class="n">results</span><span class="o">.</span><span class="n">range</span> <span class="n">from</span><span class="p">:</span> <span class="mi">54</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="mi">10</span>
<span class="n">results</span><span class="o">.</span><span class="n">range</span> <span class="n">from</span><span class="p">:</span> <span class="mi">3</span>
<span class="n">results</span><span class="o">.</span><span class="n">range</span> <span class="n">page</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="mi">30</span>
<span class="n">results</span><span class="o">.</span><span class="n">range</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">3</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">range</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">range</span> <span class="n">from</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="n">to</span><span class="p">:</span> <span class="mi">9</span>

<span class="n">results</span><span class="o">.</span><span class="n">size</span>      <span class="c1"># This will not change even if you change the range...</span>
<span class="n">results</span><span class="o">.</span><span class="n">ids</span><span class="o">.</span><span class="n">size</span>  <span class="c1"># However, this will.</span>

<span class="n">results</span><span class="o">.</span><span class="n">range</span> <span class="ss">:all</span>  <span class="c1"># Reset</span></pre></div>
      </td>
    </tr>
    <tr id='section-22'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-22">#</a>
        </div>
        <h2>Numeric indices</h2>

<p> You may index numerical attributes and perform some simple matching on them.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nc">Recipe</span> <span class="o">&lt;</span> <span class="no">Ohm</span><span class="o">::</span><span class="no">Model</span>
  <span class="n">attribute</span> <span class="ss">:serving_size</span>

  <span class="n">ion</span> <span class="p">{</span>
    <span class="n">number</span> <span class="ss">:serving_size</span>  <span class="c1"># Define a number index</span>
  <span class="p">}</span>
<span class="k">end</span>

<span class="no">Recipe</span><span class="o">.</span><span class="n">ion</span><span class="o">.</span><span class="n">search</span> <span class="p">{</span> <span class="n">number</span> <span class="ss">:serving_size</span><span class="p">,</span> <span class="mi">1</span> <span class="p">}</span>            <span class="c1"># n == 1</span>
<span class="no">Recipe</span><span class="o">.</span><span class="n">ion</span><span class="o">.</span><span class="n">search</span> <span class="p">{</span> <span class="n">number</span> <span class="ss">:serving_size</span><span class="p">,</span> <span class="n">gt</span><span class="p">:</span><span class="mi">1</span> <span class="p">}</span>         <span class="c1"># n &gt; 1</span>
<span class="no">Recipe</span><span class="o">.</span><span class="n">ion</span><span class="o">.</span><span class="n">search</span> <span class="p">{</span> <span class="n">number</span> <span class="ss">:serving_size</span><span class="p">,</span> <span class="n">gt</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="n">lt</span><span class="p">:</span><span class="mi">5</span> <span class="p">}</span>   <span class="c1"># 2 &lt; n &lt; 5</span>
<span class="no">Recipe</span><span class="o">.</span><span class="n">ion</span><span class="o">.</span><span class="n">search</span> <span class="p">{</span> <span class="n">number</span> <span class="ss">:serving_size</span><span class="p">,</span> <span class="n">min</span><span class="p">:</span> <span class="mi">4</span> <span class="p">}</span>       <span class="c1"># n &gt;= 4</span>
<span class="no">Recipe</span><span class="o">.</span><span class="n">ion</span><span class="o">.</span><span class="n">search</span> <span class="p">{</span> <span class="n">number</span> <span class="ss">:serving_size</span><span class="p">,</span> <span class="n">max</span><span class="p">:</span> <span class="mi">10</span> <span class="p">}</span>      <span class="c1"># n &lt;= 10</span></pre></div>
      </td>
    </tr>
    <tr id='section-23'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-23">#</a>
        </div>
        <h2>Sorting</h2>

<p> First, define a sort index in your model.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nc">Element</span> <span class="o">&lt;</span> <span class="no">Ohm</span><span class="o">::</span><span class="no">Model</span>
  <span class="n">attribute</span> <span class="ss">:name</span>
  <span class="n">attribute</span> <span class="ss">:protons</span>
  <span class="n">attribute</span> <span class="ss">:electrons</span>

  <span class="n">ion</span> <span class="p">{</span>
    <span class="n">sort</span>   <span class="ss">:name</span>       <span class="c1"># &lt;-- like this</span>
    <span class="n">number</span> <span class="ss">:protons</span>
  <span class="p">}</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-24'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-24">#</a>
        </div>
        <p> Now sort it like so. This will not take the search relevancy scores
 into account.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">results</span> <span class="o">=</span> <span class="no">Element</span><span class="o">.</span><span class="n">ion</span><span class="o">.</span><span class="n">search</span> <span class="p">{</span> <span class="n">number</span> <span class="ss">:protons</span><span class="p">,</span> <span class="n">gt</span><span class="p">:</span> <span class="mi">3</span><span class="o">.</span><span class="mi">5</span> <span class="p">}</span>
<span class="n">results</span><span class="o">.</span><span class="n">sort_by</span> <span class="ss">:name</span></pre></div>
      </td>
    </tr>
    <tr id='section-25'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-25">#</a>
        </div>
        <p> Note that this sorting (unlike in Ohm, et al) is case insensitive,
 and takes English articles into account (eg, &ldquo;The Beatles&rdquo; will
 come before &ldquo;Rolling Stones&rdquo;).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-26'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-26">#</a>
        </div>
        <h1>Extending Ion</h1>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-27'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-27">#</a>
        </div>
        <p> You may override it with some fancy stuff.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nc">Ion</span><span class="o">::</span><span class="no">Search</span>
  <span class="k">def</span> <span class="nf">to_ohm</span>
    <span class="n">set_key</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">key</span><span class="o">[</span><span class="s1">&#39;~&#39;</span><span class="o">][</span><span class="s1">&#39;mysearch&#39;</span><span class="o">]</span>
    <span class="n">ids</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="nb">id</span><span class="o">|</span> <span class="n">set_key</span><span class="o">.</span><span class="n">sadd</span> <span class="nb">id</span> <span class="p">}</span>
    <span class="no">Ohm</span><span class="o">::</span><span class="no">Set</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">set_key</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">set</span> <span class="o">=</span> <span class="no">Album</span><span class="o">.</span><span class="n">ion</span><span class="o">.</span><span class="n">search</span> <span class="p">{</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span> <span class="p">}</span><span class="o">.</span><span class="n">to_ohm</span></pre></div>
      </td>
    </tr>
    <tr id='section-28'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-28">#</a>
        </div>
        <p> Or extend the DSL.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nc">Ion</span><span class="o">::</span><span class="no">Scope</span>
  <span class="k">def</span> <span class="nf">keywords</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>
    <span class="n">any_of</span> <span class="p">{</span>
      <span class="n">text</span> <span class="ss">:title</span><span class="p">,</span> <span class="n">what</span>
      <span class="n">metaphone</span> <span class="ss">:artist</span><span class="p">,</span> <span class="n">what</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Album</span><span class="o">.</span><span class="n">ion</span><span class="o">.</span><span class="n">search</span> <span class="p">{</span> <span class="n">keywords</span> <span class="s2">&quot;Foo&quot;</span> <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-29'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-29">#</a>
        </div>
        <h2>Features in the works</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-30'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-30">#</a>
        </div>
        <p> These features are not implemented yet, but will be.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-31'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-31">#</a>
        </div>
        <p> TODO: search keyword blacklist.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="no">Ion</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ignored_words</span> <span class="o">+=</span> <span class="sx">%w(at it the)</span></pre></div>
      </td>
    </tr>
    <tr id='section-32'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-32">#</a>
        </div>
        <p> TODO: Quoted searching.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="no">Item</span><span class="o">.</span><span class="n">ion</span><span class="o">.</span><span class="n">search</span> <span class="p">{</span>
  <span class="n">text</span> <span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;apple &quot;MacBook Pro&quot;&#39;</span>
<span class="p">}</span>

<span class="n">results</span> <span class="o">=</span> <span class="no">Item</span><span class="o">.</span><span class="n">ion</span><span class="o">.</span><span class="n">search</span> <span class="p">{</span>
  <span class="n">text</span> <span class="ss">:title</span><span class="p">,</span> <span class="s2">&quot;Macbook&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-33'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-33">#</a>
        </div>
        <p> TODO: exclusions.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">exclude</span> <span class="p">{</span>
    <span class="n">text</span> <span class="ss">:title</span><span class="p">,</span> <span class="s2">&quot;Case&quot;</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-34'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-34">#</a>
        </div>
        <p> TODO: descending sort (and multi-field sort)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">results</span><span class="o">.</span><span class="n">sort_by</span> <span class="ss">:name</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="ss">:desc</span></pre></div>
      </td>
    </tr>
    <tr id='section-35'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-35">#</a>
        </div>
        <p> TODO: facets</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">results</span><span class="o">.</span><span class="n">facet_counts</span> <span class="c1">#=&gt; { :name =&gt; { &quot;Ape&quot; =&gt; 2, &quot;Banana&quot; =&gt; 3 } } ??</span></pre></div>
      </td>
    </tr>
    <tr id='section-36'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-36">#</a>
        </div>
        <h1>Quirks</h1>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-37'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-37">#</a>
        </div>
        <h2>Searching with arity</h2>

<p> The search DSL may leave some things in accessible since the block will
 be ran through <code>instance_eval</code> in another context. You can get around it
 via:</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="no">Book</span><span class="o">.</span><span class="n">ion</span><span class="o">.</span><span class="n">search</span> <span class="p">{</span> <span class="n">text</span> <span class="ss">:name</span><span class="p">,</span> <span class="vi">@name</span> <span class="p">}</span>        <span class="c1"># fail</span>
<span class="no">Book</span><span class="o">.</span><span class="n">ion</span><span class="o">.</span><span class="n">search</span> <span class="p">{</span> <span class="o">|</span><span class="n">q</span><span class="o">|</span> <span class="n">q</span><span class="o">.</span><span class="n">text</span> <span class="ss">:name</span><span class="p">,</span> <span class="vi">@name</span> <span class="p">}</span>  <span class="c1"># good</span></pre></div>
      </td>
    </tr>
    <tr id='section-38'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-38">#</a>
        </div>
        <p> Or you may also take advantage of Ruby closures:</p>

      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">name</span> <span class="o">=</span> <span class="vi">@name</span>
<span class="no">Book</span><span class="o">.</span><span class="n">ion</span><span class="o">.</span><span class="n">search</span> <span class="p">{</span> <span class="n">text</span> <span class="ss">:name</span><span class="p">,</span> <span class="nb">name</span> <span class="p">}</span>         <span class="c1"># good</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
